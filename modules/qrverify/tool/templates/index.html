{% extends "module_base.html" %}

{% block title %}QR Verify{% endblock %}
{% block heading %}QR Verify{% endblock %}
{% block description %}Check QR contents, validate signatures, and trace origin.{% endblock %}

{% block extra_styles %}
      .status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 12px;
      }

      .status.valid {
        background: rgba(55, 214, 122, 0.15);
        color: #37d67a;
      }

      .status.invalid {
        background: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.78rem;
        color: #f8f7ff;
        background: linear-gradient(135deg, rgba(60, 201, 255, 0.2), rgba(123, 92, 255, 0.2));
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 14px;
        display: none;
      }

      .badge.visible {
        display: inline-flex;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
      }

      .meta-item {
        display: grid;
        gap: 4px;
      }

      .meta-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: rgba(245, 247, 251, 0.45);
      }

      .meta-value {
        font-size: 0.95rem;
      }
{% endblock %}

{% block form %}
<form id="verify-form" enctype="multipart/form-data">
  <label for="file">Upload QR image (PNG/JPG)</label>
  <input id="file" name="file" type="file" accept="image/*">

  <label for="payload">Or paste payload</label>
  <textarea id="payload" name="payload" placeholder='{"payload": "...", "signature": "..."}'></textarea>

  <button type="submit">Verify QR</button>
</form>
{% endblock %}

{% block result %}
<section id="result" class="result">
  <div id="status" class="status">STATUS</div>
  <div id="sparky-badge" class="badge">Created by Sparky Universe</div>
  <div class="meta-grid">
    <div class="meta-item">
      <span class="meta-label">Issuer</span>
      <span id="issuer" class="meta-value">-</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Signature</span>
      <span id="signature" class="meta-value">-</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Timestamp</span>
      <span id="timestamp" class="meta-value">-</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Forge</span>
      <span id="forge" class="meta-value">-</span>
    </div>
  </div>
  <pre id="decoded">-</pre>
</section>
{% endblock %}

{% block meta %}
<span>No accounts. No database. Just verify.</span>
<a href="/docs" target="_blank" rel="noreferrer">Open API docs</a>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById("verify-form");
  const result = document.getElementById("result");
  const statusEl = document.getElementById("status");
  const issuerEl = document.getElementById("issuer");
  const signatureEl = document.getElementById("signature");
  const timestampEl = document.getElementById("timestamp");
  const forgeEl = document.getElementById("forge");
  const decodedEl = document.getElementById("decoded");
  const badgeEl = document.getElementById("sparky-badge");
  const flow = document.getElementById("sparky-flow");

  const updateStatus = (ok, label) => {
    statusEl.classList.remove("valid", "invalid");
    statusEl.classList.add(ok ? "valid" : "invalid");
    statusEl.textContent = label;
  };

  const showFlow = () => {
    if (flow && flow.dataset.hasLinks === "true") {
      flow.classList.add("visible");
    }
  };

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(form);

    const response = await fetch("/verify", {
      method: "POST",
      body: formData,
    });

    const data = await response.json();
    result.classList.add("visible");

    if (data.error) {
      updateStatus(false, "Invalid");
      issuerEl.textContent = "-";
      signatureEl.textContent = "-";
      timestampEl.textContent = "-";
      forgeEl.textContent = "-";
      decodedEl.textContent = data.error;
      badgeEl.classList.remove("visible");
      showFlow();
      return;
    }

    updateStatus(Boolean(data.valid), data.valid ? "Valid" : "Invalid");
    issuerEl.textContent = data.issuer || "-";
    signatureEl.textContent = data.signature || "-";
    timestampEl.textContent = data.timestamp || "-";

    if (data.forge_url) {
      forgeEl.innerHTML = `<a href="${data.forge_url}" target="_blank" rel="noreferrer">Open Forge</a>`;
    } else {
      forgeEl.textContent = "-";
    }

    const decodedPayload = data.payload ? JSON.stringify(data.payload, null, 2) : data.decoded;
    decodedEl.textContent = decodedPayload || "-";

    if (data.issuer === "sparky" && data.signature === "ok") {
      badgeEl.classList.add("visible");
    } else {
      badgeEl.classList.remove("visible");
    }

    showFlow();
  });
</script>
{% endblock %}
